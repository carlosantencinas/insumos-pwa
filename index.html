<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Insumos PWA</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; }
    input { margin: 0.5rem; padding: 0.5rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background: #eee; }
  </style>
</head>
<body>
  <h1>Lista de Insumos</h1>
  <input type="text" id="filtroNombre" placeholder="Filtrar por nombre" oninput="filtrar()" />
  <input type="text" id="filtroUnidad" placeholder="Filtrar por unidad" oninput="filtrar()" />
  <input type="number" id="filtroCantidad" placeholder="Cantidad mínima" oninput="filtrar()" />
  
  <table>
    <thead>
      <tr>
        <th>Descripción</th>
        <th>Unidad</th>
        <th>Cantidad</th>
        <th>Precio Unitario</th>
        <th>Parcial (Bs)</th>
      </tr>
    </thead>
    <tbody id="tablaInsumos"></tbody>
  </table>

  <h2>Top 3 por Cantidad</h2>
  <ul id="topCantidad"></ul>

  <h2>Top 3 por Costo Parcial</h2>
  <ul id="topCosto"></ul>

  <script>
    let insumos = [];

    function cargarCSV() {
      Papa.parse('insumos.csv', {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          insumos = results.data.map(row => ({
            Descripcion: row['Descripción insumos'],
            Unidad: row['Und.'],
            Cantidad: parseFloat(row['Cant.']),
            Unitario: parseFloat(row['Unit.']),
            Parcial: parseFloat(row['Parcial (Bs)'])
          }));
          mostrarTabla(insumos);
          mostrarTop(insumos);
        }
      });
    }

    function filtrar() {
      const nombre = document.getElementById('filtroNombre').value.toLowerCase();
      const unidad = document.getElementById('filtroUnidad').value.toLowerCase();
      const cantidad = parseFloat(document.getElementById('filtroCantidad').value) || 0;

      const filtrados = insumos.filter(i =>
        i.Descripcion.toLowerCase().includes(nombre) &&
        i.Unidad.toLowerCase().includes(unidad) &&
        i.Cantidad >= cantidad
      );

      mostrarTabla(filtrados);
      mostrarTop(filtrados);
    }

    function mostrarTabla(data) {
      const tbody = document.getElementById('tablaInsumos');
      tbody.innerHTML = data.map(i => `
        <tr>
          <td>${i.Descripcion}</td>
          <td>${i.Unidad}</td>
          <td>${i.Cantidad}</td>
          <td>${i.Unitario}</td>
          <td>${i.Parcial}</td>
        </tr>`
      ).join('');
    }

    function mostrarTop(data) {
      const topCantidad = [...data].sort((a, b) => b.Cantidad - a.Cantidad).slice(0, 3);
      const topCosto = [...data].sort((a, b) => b.Parcial - a.Parcial).slice(0, 3);

      document.getElementById('topCantidad').innerHTML = topCantidad.map(i => `<li>${i.Descripcion} (${i.Cantidad})</li>`).join('');
      document.getElementById('topCosto').innerHTML = topCosto.map(i => `<li>${i.Descripcion} (${i.Parcial} Bs)</li>`).join('');
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }

    cargarCSV();
  </script>
</body>
</html>
